{% extends "base.html" %} {% block body %}
<div class="container mt-5">
  <div class="row">
    <!-- Course Details Card -->
    <div class="col-lg-8">
      <div class="card mb-4">
        <div class="card-body">
          <!-- Course Header -->
          <div class="d-flex justify-content-between align-items-start mb-4">
            <div>
              <h2 class="card-title">{{ course.title }}</h2>
              <p class="text-muted">{{ course.code }}</p>
            </div>
            <!-- Availability Badge -->
            {% if course.availability %}
            <span class="badge bg-success">Available</span>
            {% else %}
            <span class="badge bg-danger">Closed</span>
            {% endif %}
          </div>

          <!-- Course Information -->
          <div class="row mb-4">
            <div class="col-md-6">
              <p><strong>Professor:</strong> {{ course.professor }}</p>
              <p><strong>Units:</strong> {{ course.credits }}</p>
              <p><strong>Format:</strong> {{ course.format }}</p>
            </div>
            <div class="col-md-6">
              <p>
                <strong>Enrolled Students:</strong> {{ enrolled_count }} {% if
                course.max_students %} / {{ course.max_students }} {% endif %}
              </p>
              {% if available_spots %}
              <p><strong>Available Spots:</strong> {{ available_spots }}</p>
              {% endif %}
            </div>
          </div>

          <!-- Course Description -->
          <div class="mb-4">
            <h5>Course Description</h5>
            <p>{{ course.description or 'No description available.' }}</p>
          </div>

          <!-- Action Buttons -->
          <div class="d-flex gap-2">
            {% if current_user.is_authenticated %} {% if is_enrolled %}
            <!-- Drop Course Button -->
            <form
              method="POST"
              action="{{ url_for('main.drop_course', course_id=course.id) }}"
              style="display: inline"
            >
              <button
                type="submit"
                class="btn btn-danger"
                onclick="return confirm('Are you sure you want to drop this course?')"
              >
                Drop Course
              </button>
            </form>

            {% elif course.availability %}
            <!-- Enroll Button -->
            <form
              method="POST"
              action="{{ url_for('main.enroll_course', course_id=course.id) }}"
              style="display: inline"
            >
              <button type="submit" class="btn btn-primary">Enroll Now</button>
            </form>

            <!-- Update -->
            <a href="/courses/{{course.id}}/update" class="btn btn-secondary">
              Update Course</a
            >

            {% else %}
            <button type="button" class="btn btn-secondary" disabled>
              Course Not Available
            </button>
            {% endif %} {% else %}
            <!-- Login Required -->
            <a href="{{ url_for('auth.login') }}" class="btn btn-primary">
              Login to Enroll
            </a>
            {% endif %}

            <!-- Delete Button -->
            <form
              method="POST"
              action="{{ url_for('main.delete_course', course_id=course.id) }}"
              style="display: inline"
            >
              <button
                type="submit"
                class="btn btn-danger"
                onclick="return confirm('Are you sure you want to delete this course?')"
              >
                Delete Course
              </button>
            </form>
            <!-- Back Button -->
            <a
              href="{{ url_for('main.courses_list') }}"
              class="btn btn-outline-secondary"
            >
              Back to Courses
            </a>
          </div>
        </div>
      </div>

      <!-- Enrolled Students Section (Admin/Instructor View) -->
      {% if current_user.is_authenticated and current_user.role == 'instructor'
      %}
      <div class="card">
        <div class="card-header bg-light">
          <h5 class="mb-0">Enrolled Students</h5>
        </div>
        <div class="card-body">
          {% set students = course.get_enrolled_students() %} {% if students %}
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Email</th>
                <th>Role</th>
                <th>Enrolled Date</th>
                <th>Grade</th>
              </tr>
            </thead>
            <tbody>
              {% for student in students %}
              <tr>
                <td>{{ student.email }}</td>
                <td>{{ student.role|capitalize }}</td>
                <td>{{ enrollment.grade or '-' }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% else %}
          <p class="text-muted">No students enrolled yet.</p>
          {% endif %}
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
      <!-- Course Stats Card -->
      <div class="card mb-4">
        <div class="card-header bg-light">
          <h5 class="mb-0">Course Stats</h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <label class="text-muted small">Course Code</label>
            <p class="h6">{{ course.code }}</p>
          </div>
          <div class="mb-3">
            <label class="text-muted small">Units</label>
            <p class="h6">{{ course.credits }}</p>
          </div>
          <div class="mb-3">
            <label class="text-muted small">Format</label>
            <p class="h6">
              <span class="badge bg-info">{{ course.format }}</span>
            </p>
          </div>
          <div class="mb-3">
            <label class="text-muted small">Enrollment Status</label>
            <p class="h6">
              {% if is_enrolled and current_user.is_authenticated %}
              <span class="badge bg-success">Enrolled</span>
              {% else %}
              <span class="badge bg-secondary">Not Enrolled</span>
              {% endif %}
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
